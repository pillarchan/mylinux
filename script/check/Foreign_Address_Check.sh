netease_ip=$(host api.netease.im | grep address| awk '{print $NF}')
ip_filter="18.162.60.253|43.198.73.220|100.125.0.41|13.213.180.3|18.163.86.134|18.167.243.84|43.243.176.45|154.218.6.6|16.162.38.155|46.8.196|16.162.184.155|18.166.23.210|18.166.90.230|18.162.136.22|18.163.174.124|18.167.201.132|47.57.185.171|46.8.199.215|103.70.227|18.166.183.159|103.70.227.122|182.255.62.98|156.227.27.76|18.166.112.245|18.167.135.67|2.59.155.27|18.167.2.105|35.183.99.90|13.224.154.32|18.167.55.32|16.162.203.229|85.8.182.85|47.57.186.11|16.162.142.132|16.162.251.222|18.167.39.236|18.166.250.96|16.163.51.40|103.70.225.131|182.255.62.206|103.70.225.136|164.88.100.4|2.59.155.111|45.11.47|182.255.62.206|164.88.100.4|85.8.182.152|45.11.4716.163.51.40|18.166.43.229|16.162.97|13.225.103|16.162.168.87|16.163.81.183|18.167.100.241|13.75.42.91|23.98.36.158|18.163.83.44|54.192.18.28|16.162.95|54.82.112.237|16.162.60.69|110.75.231.202|16.162.56.80|172.68|138.113|103.17.26.92|18.162.205|18.166.96|172.68.118|210.71.196.14|18.166.149.39|210.71.196.12|162.158|138.113.203|116.251.234.5|18.166.182.123|16.162.211.100|18.167.2.183|138.113.198.10|47.242.6.172|138.113.198.12|18.163.43.214|172.68.143|18.166.232.156|35.241.90.228|162.158.92.61|172.68.133|18.163.249.224|18.163.254.32|18.163.254.80|18.163.72.107|18.166.10.155|18.166.103.225|18.166.121.9|18.166.142.93|18.166.147.124|18.166.163.47|18.166.168.116|18.166.185.74|18.166.196.78|18.166.35.203|18.166.6.40|18.166.8.222|18.166.82.94|18.166.85.167|18.166.97.59|18.167.162.176|18.167.170.84|18.167.45.50|18.167.61.139|18.166.83.223|47.112.125.158|16.162.20.205|172.70|47.242.79.63|104.21|103.21.244|103.22.200|103.31.4|104.16.0|104.24.0|108.162.192|131.0.72|141.101.64|162.158.0|172.64.0|173.245.48|188.114.96|190.93.240|197.234.240|198.41.128|127.0.0.1|0.0.0.0:*|:::*|172.31|16.162.13.38|16.162.125.103|94.74.107.186|8.210.176.50|16.162.0.156|138.113.52|172.69|18.163.165.241|172.67|108.162.215|1.180.19|1.25.242|101.106.8|101.202.16|101.205.173|101.246.182|101.69.134|101.69.162|101.69.194|101.70.152|101.71.125|101.71.69|101.71.85|101.71.86|101.79.227|101.79.228|103.1.138|103.114.101|103.213.96|103.24.177|103.254.190|103.45.79|103.56.116|103.56.117|106.3.208|106.3.210|106.3.213|106.8.46|110.16.62|110.16.63|110.18.242|110.42.104|110.42.105|110.80.141|111.10.29|111.123.40|111.123.43|111.161.122|111.206.176|111.225.214|111.31.16|111.47.221|111.48.88|111.6.177|111.6.188|111.6.241|111.62.54|111.62.90|111.63.53|112.240.57|112.240.60|112.28.236|112.28.237|112.49.19|112.49.40|112.81.238|112.90.131|112.90.133|112.91.129|113.142.87|113.16.212|113.194.59|113.207.0|113.207.10|113.219.160|113.8.150|113.96.147|114.113.82|115.223.7|115.231.132|115.231.16|115.231.24|115.238.202|115.238.246|115.238.254|116.162.21|116.211.248|116.211.251|117.147.208|117.149.151|117.149.154|117.149.246|117.161.19|117.161.6|117.27.241|117.27.244|117.48.217|118.112.241|118.112.249|118.184.169|118.184.176|118.184.178|119.206.200|119.79.243|120.195.6|120.199.85|120.199.86|120.199.91|120.201.7|120.209.142|120.221.23|120.221.64|120.221.65|120.226.60|120.232.191|120.240.97|120.253.33|120.39.209|121.14.243|121.18.168|121.18.212|121.46.226|122.195.144|122.228.21|122.228.22|122.228.23|122.228.230|122.228.233|122.228.237|122.228.25|122.70.142|123.103.115|123.103.125|123.103.127|123.184.109|123.184.158|124.14.17|124.167.240|124.95.146|125.44.103|125.44.104|125.77.129|125.77.131|125.77.138|125.77.139|125.77.140|125.77.16|132.147.114|138.113.112|138.113.114|138.113.39|138.113.42|138.113.46|138.113.47|138.113.48|14.0.112|14.0.113|14.0.41|14.0.43|14.0.44|14.0.46|14.128.0|14.128.1|14.204.185|14.205.40|150.138.167|157.0.2|157.185.144|157.185.145|157.185.146|157.185.156|157.185.158|157.185.160|157.185.161|157.185.163|157.185.169|157.185.170|157.185.172|157.185.175|157.185.177|157.185.178|157.185.179|157.185.190|159.226.225|161.189.185|161.189.83|163.171.128|163.171.129|163.171.130|163.171.131|163.171.132|163.171.133|163.171.135|163.171.137|163.171.138|163.171.139|163.171.140|163.171.141|163.171.142|163.171.144|163.171.145|163.171.146|163.171.147|163.171.189|163.171.193|163.171.196|163.171.197|163.171.198|163.171.199|163.171.200|163.171.203|163.171.204|163.171.205|163.171.206|163.171.208|163.171.209|163.171.210|163.171.211|163.171.213|163.171.214|163.171.92|163.171.93|163.177.132|163.177.243|180.101.154|180.101.30|180.101.58|180.97.211|183.131.117|183.131.177|183.134.12|183.134.31|183.201.225|183.201.234|183.204.63|183.230.78|183.230.84|183.239.106|183.240.117|183.245.146|183.245.149|183.245.160|183.245.6|183.245.8|183.246.192|183.249.207|202.171.253|205.252.239|210.61.180|210.61.181|210.61.206|210.61.207|211.142.194|211.91.52|218.1.70|218.29.49|218.98.14|218.98.46|219.144.72|219.144.75|220.202.155|220.242.128|220.242.130|220.242.138|220.242.152|220.242.157|220.242.158|220.242.170|220.242.176|220.242.177|220.242.211|221.12.140|221.178.0|221.180.192|221.182.23|221.194.139|221.229.224|221.230.143|221.6.148|221.6.211|222.185.224|222.186.130|222.186.132|222.186.20|222.243.141|222.243.43|222.28.152|222.79.64|223.111.14|223.111.16|223.111.162|223.111.164|223.111.17|223.111.177|223.111.178|223.111.179|223.111.198|223.112.226|223.113.54|223.151.245|223.210.26|27.109.126|27.148.140|27.148.141|27.148.143|27.155.70|27.155.92|27.195.145|36.111.141|36.150.31|36.156.29|36.156.77|36.248.208|36.248.28|36.249.0|36.250.86|36.250.87|36.250.93|36.66.223|36.66.90|36.99.198|42.157.197|42.56.85|42.81.144|43.243.234|43.243.235|43.247.103|45.115.167|45.116.82|45.116.83|45.124.125|49.221.137|58.20.160|58.216.95|58.222.43|58.222.46|58.223.172|58.241.88|58.26.103|59.83.232|60.12.125|60.210.11|61.110.192|61.110.193|61.110.194|61.110.195|61.110.196|61.110.197|61.110.198|61.110.199|61.110.200|61.110.201|61.110.202|61.110.203|61.110.204|61.110.205|61.110.206|61.110.207|61.160.12|61.162.101|61.163.111|61.164.247|61.164.251|61.172.238|61.241.102|61.241.98|119.13.79.5|199.212.57.43|46.8.198.136|${netease_ip}"
netstat -ntlupa| grep ESTABLISHED > /tmp/tmp_txt
ip_list=$(awk 'NR>2&&$5!~"'$ip_filter'"{print $5}' /tmp/tmp_txt | awk -F":" '{print $1}' | sort | uniq)
for i in $ip_list
do
    proc=$(grep $i /tmp/tmp_txt | head -1 | awk '{for (i=7;i<=NF;i++)printf("%s ", $i);print ""}')
    country=$(curl -s "http://ip-api.com/json/$i?lang=zh-CN" | jq '.country')
    isp=$(curl -s "http://ip-api.com/json/$i?lang=zh-CN" | jq '.isp')
    if [[ ! $country =~ "阿联酋" ]] && [[ ! "${isp[@]}"  =~ "Cloudflare" ]] && [[ ! "${proc[@]}" =~ "nginx" ]] && [[ ! "${proc[@]}" =~ "chronyd" ]] && [[ ! "${proc[@]}" =~ "WorkerMan" ]] && [[ ! "${proc[@]}" =~ "Swoole" ]]; then
MSG=":: 外链检测 ::
<pre>主机名: $(hostname)
IP: $i
$(curl -s "http://ip-api.com/json/$i?lang=zh-CN" | jq '.country,.city,.isp'|xargs)
PID/进程: $proc
</pre>"
curl -X POST --data chat_id="-736954570" --data-urlencode "text=${MSG}" "https://api.telegram.org/bot5240878837:AAFq-JRxvsAgfAh7bQg7Zkm7bVYsgyI4dF4/sendMessage?parse_mode=HTML"
    fi
done
